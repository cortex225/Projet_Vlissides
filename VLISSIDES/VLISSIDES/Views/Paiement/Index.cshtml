@model VLISSIDES.ViewModels.Paiement.StripePaiementVM
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Paiement";
    string myURL = Context.Request.Host.Value;
    string BASE_URL_RAZOR = Url.Content("~");
}


<div class="m-4">
    <div class="d-flex justify-content-center">
        <div class="w-50">
            <div class="stepper d-flex justify-content-between">
                <button id="step1" type="button" class="btn btn-default btn-circle btnStepper" onclick="stepperAdresse()">
                    1
                </button>

                <button id="step2" type="button" class="btn btn-default btn-circle btnStepper" onclick="stepperInfoPaiement()">
                    2
                </button>

                <button id="step3" type="button" class="btn btn-default btn-circle btnStepper" onclick="stepperConfirmation()">
                    3
                </button>
            </div>

            <div class="hrDiv">
                <hr/>
            </div>
        </div>
    </div>


    <div class="m-4">
        <div id="adressePage">
            <h2>Adresse</h2>
            <div class="rcorners m-2 p-4 overflow-hidden">
                <h5 class="my-2">Adresse ligne 1</h5>
                <div class="row">

                    <div class="col-2 ">
                        <div class="form-group form-group-static">
                            <label asp-for="Adresse.NoCivique" class="control-label mb-2"></label>
                            <input asp-for="Adresse.NoCivique" class="form-control" type="text" placeholder="@Html.DisplayFor(model => model.Adresse.NoCivique)"/>
                            <span asp-validation-for="Adresse.NoCivique" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-10">
                        <div class="form-group form-group-static">
                            <label asp-for="Adresse.Rue" class="control-label mb-2"></label>
                            <input asp-for="Adresse.Rue" class="form-control" type="text" placeholder="@Html.DisplayFor(model => model.Adresse.Rue)"/>
                            <span asp-validation-for="Adresse.Rue" class="text-danger"></span>
                        </div>
                    </div>

                </div>
                <h5 class="my-2">Adresse ligne 2</h5>
                <div class="row">
                    <div class="col-12">
                        <div class="form-group form-group-static">
                            <label asp-for="Adresse.NoApartement" class="control-label mb-2"></label>
                            <input asp-for="Adresse.NoApartement" class="form-control" type="text" placeholder="@Html.DisplayFor(model => model.Adresse.NoApartement)"/>
                            <span asp-validation-for="Adresse.NoApartement" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-2">
                        <div class="form-group form-group-static">
                            <label asp-for="Adresse.CodePostal" class="control-label mb-2"></label>
                            <input asp-for="Adresse.CodePostal" class="form-control" type="text" placeholder="@Html.DisplayFor(model => model.Adresse.CodePostal)"/>
                            <span asp-validation-for="Adresse.CodePostal" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col"></div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="form-group form-group-static">
                            <label asp-for="Adresse.Ville" class="control-label mb-2"></label>
                            <input asp-for="Adresse.Ville" class="form-control" type="text" placeholder="@Html.DisplayFor(model => model.Adresse.Ville)"/>
                            <span asp-validation-for="Adresse.Ville" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group form-group-static">
                            <label asp-for="Adresse.Province" class="control-label mb-2"></label>
                            <input asp-for="Adresse.Province" class="form-control" type="text" placeholder="@Html.DisplayFor(model => model.Adresse.Province)"/>
                            <span asp-validation-for="Adresse.Province" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group form-group-static">
                            <label asp-for="Adresse.Pays" class="control-label mb-2"></label>
                            <input asp-for="Adresse.Pays" class="form-control" type="text" placeholder="@Html.DisplayFor(model => model.Adresse.Pays)"/>
                            <span asp-validation-for="Adresse.Pays" class="text-danger"></span>
                        </div>
                    </div>

                </div>

                <div class="navigationButtons my-4">
                    <button id="checkout-button" class="btn btn-primary btn-md float-end mt-6 mb-0 mx-3">Procéder au paiement</button>
                    <button class="btn btn-primary btn-md float-end mt-6 mb-0" onclick="location.href='@Url.Action("Index", "Panier")'" type="button">Retour au panier</button>

                </div>
            </div>
        </div>

        <div id="paiementPage" class="d-none">
            <div class="rcorners m-2 p-4 overflow-hidden d-flex justify-content-center mx-auto my-auto" style="width: fit-content">

                <div class="navigationButtons my-4">
                    <h3 class="d-flex justify-content-center text-center ">
                        Création de la session de paiement en cours...
                    </h3>
                    @* //Creation d'un loader *@
                    <div class="spinner-border text-primary d-flex justify-content-center mx-auto mt-4 mb-4" role="status" style="width: 4rem; height: 4rem;">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            </div>


        </div>

    </div>
</div>

<script type="text/javascript">
    const BASE_URL = @Json.Serialize(BASE_URL_RAZOR);
    var checkoutButton = document.getElementById('checkout-button');
    function createCheckoutSession() {
        var stripe = Stripe('pk_test_51O3gRDAIrJUcHyNnVbRxxrTEmN0ndzgrocNP008WZgRBHCFJNXhNXnXYyfxU1im6XjmLPKmJT1Tq64eNf5vIysOu00LWHU5Ohx');

        return fetch(BASE_URL+'/Paiement/CreateCheckoutSession', {
            method: 'POST',
        }).then(function (response) {
            return response.json();
        }).then(function (session) {
            return stripe.redirectToCheckout({ sessionId: session.id });
        }).then(function (result) {

            if (result.error) {
                alert(result.error.message);
            }
        }).catch(function (error) {
            console.error('Error:', error);
        });
    }
    checkoutButton.addEventListener('click', function () {
        createCheckoutSession();
    });
</script>


<script src="https://js.stripe.com/v3/"></script>


@section Scripts {
    <script type="text/javascript">
        step1 = document.getElementById("step1");
        step2 = document.getElementById("step2");
        step3 = document.getElementById("step3");

        adressePage = document.getElementById("adressePage");
        paiementPage = document.getElementById("paiementPage");
        confirmationPage = document.getElementById("confirmationPage");

        step1.style.backgroundColor = "#3B71CA";
        step1.style.color = "white";

        function stepperAdresse() {
            step1.style.backgroundColor = "#3B71CA";
            step1.style.color = "white";

            step2.style.backgroundColor = "white";
            step2.style.color = "#4F4F4F";

            step3.style.backgroundColor = "white";
            step3.style.color = "#4F4F4F";

            adressePage.className = "";
            paiementPage.className = "d-none";
            confirmationPage.className = "d-none";

        }
        function stepperInfoPaiement() {
            step1.style.backgroundColor = "#14A44D";
            step1.style.color = "white";

            step2.style.backgroundColor = "#3B71CA";
            step2.style.color = "white";

            step3.style.backgroundColor = "white";
            step3.style.color = "#4F4F4F";

            adressePage.className = "d-none";
            paiementPage.className = "";
            confirmationPage.className = "d-none";
            createCheckoutSession();
        }
        function stepperConfirmation() {
            step1.style.backgroundColor = "#14A44D";
            step1.style.color = "white";

            step2.style.backgroundColor = "#14A44D";
            step2.style.color = "white";

            step3.style.backgroundColor = "#3B71CA";
            step3.style.color = "white";

            adressePage.className = "d-none";
            paiementPage.className = "d-none";
            confirmationPage.className = "";


        }
    </script>
}

<style>
    .btn-circle.btnStepper {
        width: 50px;
        height: 50px;
        padding: 10px 16px;
        border-radius: 35px;
        font-size: 20px;
        line-height: 1.33;
        background-color: white;
        z-index: 10;
    }

    .btnStepper:active {
        background-color: grey !important;
    }
    .btn-circle {
        width: 30px;
        height: 30px;
        padding: 6px 0px;
        border-radius: 15px;
        text-align: center;
        font-size: 12px;
        line-height: 1.42857;
    }

    .hrDiv{
        position: relative;
        top: -40px;
        z-index: 0;
    }

    .stepper{
        z-index: 10;
    }

    .rcorners {
        border-radius: 25px;
        background-color: white;

    }

</style>